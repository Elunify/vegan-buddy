<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign In / Make Profile</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
</head>
<body>

  <!-- Login Section -->
<div id="loginSection">
  <h1>Welcome! Sign in or create a profile</h1>
  <input type="email" id="signEmail" placeholder="Enter your email" />
  <input type="password" id="signPassword" placeholder="Enter your password" />
  <button id="signInBtn">Sign In</button>

  <div id="forgotPassword" style="margin-bottom: 0.5rem;">
      <a href="#" id="forgotPasswordLink">Forgot your password?</a>
      <div id="forgotMsg" style="color: green; margin-top: 5px;"></div>
  </div>

  <button id="showProfileBtn">Create Profile</button>
</div>

<!-- New Profile Section -->
<div id="newProfileStep1" style="display:none;">
  <h2>Create a Profile</h2>
  <label class="smallLabel">Email:</label><br>
  <input type="text" id="profileEmail" placeholder="Your email" />
  <div id="passwordSection">
    <label class="smallLabel">Create a password</label>
    <input type="password" id="profilePassword1" placeholder="Enter password">
    <input type="password" id="profilePassword2" placeholder="Confirm password">
  </div>
  <div id="emailStatus" style="color: green; min-height: 20px;"></div>
  <button id="newProfileBtn">Create an account</button>
  <button id="backToLoginBtn" style="margin-top: 10px;">Do you have a profile already?</button>
</div>

<!-- Hidden Verification Code Section -->
<div id="verifyCodeSection" style="display:none;">
  <h3>Enter Verification Code</h3>
  <input type="text" id="verificationCode" placeholder="Enter code" />
  <button id="verifyCodeBtn">Verify</button>
</div>

<p id="statusMsg"></p>

<script>
const supabaseUrl = 'https://pqrgvelzxmtdqrofxujx.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxcmd2ZWx6eG10ZHFyb2Z4dWp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMTc0ODAsImV4cCI6MjA3MTY5MzQ4MH0.s8JZLDdzIS1wBLln0Zs3LK_9BHelUcbRhyAC_0-5sos';
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

const statusMsg = document.getElementById("statusMsg");
emailjs.init("_BvHMRNPejeC7Wsha");

function setStatus(msg, color = "red") {
  statusMsg.style.color = color;
  statusMsg.textContent = msg || "";
}

// Show profile section
document.getElementById("showProfileBtn").addEventListener("click", () => {
  document.getElementById("loginSection").style.display = "none";
  document.getElementById("newProfileStep1").style.display = "block";
  setStatus("");
});

// Back to login
document.getElementById("backToLoginBtn").addEventListener("click", () => {
  document.getElementById("newProfileStep1").style.display = "none";
  document.getElementById("loginSection").style.display = "block";
  setStatus("");
});

// Check if logged in
// (async () => {
//  const { data: { user } } = await supabase.auth.getUser();
//  if (user) window.location.href = "mainpage.html";
//})();

// ------------------ Login ------------------
document.getElementById("signInBtn").addEventListener("click", async () => {
  setStatus("");
  const email = document.getElementById("signEmail").value.trim();
  const password = document.getElementById("signPassword").value.trim();
  if (!email || !password) return setStatus("Please enter both email and password");

  try {
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });

    if (error) {
      // Always return generic error for security
      return setStatus("Invalid email or password");
    }

    setStatus("Login successful!", "green");
    window.location.href = "mainpage.html";

  } catch (err) {
    console.error("Login error:", err);
    setStatus("Something went wrong. Try again later.");
  }
});

// ------------------ Generate 6-digit code ------------------
function generateCode(length = 6) {
  let code = '';
  for (let i = 0; i < length; i++) code += Math.floor(Math.random() * 10);
  return code;
}

// ------------------ Send verification code ------------------
async function sendVerificationCode(email) {
  const code = generateCode();
  const nowIso = new Date().toISOString();

  // upsert so there's only one row per email (requires unique index on email)
  const { error: dbError } = await supabase
    .from('email_verifications')
    .upsert([{ email, code, created_at: nowIso, verified: false }], { onConflict: 'email' });

  if (dbError) {
    console.error("DB save error:", dbError);
    return setStatus("Failed to save verification code. Try again later.");
  }

  try {
    await emailjs.send("service_50i8a3q", "template_0g6ty24", {
      user_email: email,
      verification_code: code
    });
    document.getElementById("verifyCodeSection").style.display = "block";
  } catch (err) {
    console.error("EmailJS send error:", err);
    // If email send fails, we might want to remove the saved code so users can retry
    await supabase.from('email_verifications').delete().eq('email', email);
    setStatus("Failed to send verification email. Try again later.");
  }
}

// ------------------ Temp storage ------------------
let tempEmail = "";
let tempPassword = "";
let codeSentEmails = {}; // { email: timestamp } to track rate limiting

// ------------------ Request verification (step 1) ------------------
document.getElementById("newProfileBtn").addEventListener("click", async () => {
  setStatus("");
  const email = document.getElementById("profileEmail").value.trim();
  const password = document.getElementById("profilePassword1").value.trim();
  const password2 = document.getElementById("profilePassword2").value.trim();

  if (!email || !password || !password2) return setStatus("Please fill in all fields");
  if (password !== password2) return setStatus("Passwords don't match");
  if (password.length < 6) return setStatus("Password must be at least 6 characters long");

  tempEmail = email;
  tempPassword = password;

  const { data: existingProfile } = await supabase
  .from('profiles')
  .select('id')
  .eq('email', tempEmail)
  .single();

if (existingProfile) {
  return setStatus("A profile with this email already exists");
}

  // Rate limit: 1 code per 2 minutes
  const lastSent = codeSentEmails[email] || 0;
  if (Date.now() - lastSent < 2 * 60 * 1000) {
    return setStatus("Verification code already sent. Please wait a bit.", "orange");
  }

  codeSentEmails[email] = Date.now();

  document.getElementById("newProfileStep1").style.display = "none";
  document.getElementById("verifyCodeSection").style.display = "block";

  try {
    await sendVerificationCode(email);
    setStatus("Verification code sent! Check your email.", "green");
  } catch (err) {
    console.error("Failed to send verification code:", err);
    setStatus("Failed to send verification code. Try again later.", "red");
    codeSentEmails[email] = 0; // allow retry
  }
});

// ------------------ Verify code + create user (step 2) ------------------
document.getElementById('verifyCodeBtn').addEventListener('click', async () => {
  setStatus("");
  const inputCode = document.getElementById('verificationCode').value.trim();
  if (!inputCode) return setStatus("Please enter the verification code");

  try {
    // Get the latest unverified code for this email
    const { data: codeData, error: codeError } = await supabase
      .from("email_verifications")
      .select("*")
      .eq("email", tempEmail)
      .eq("verified", false)
      .order("created_at", { ascending: false })
      .limit(1)
      .single();

    if (codeError || !codeData) return setStatus("No code found for this email");

    // ✅ Expiration check using created_at (10 minutes)
    const createdAt = new Date(codeData.created_at);
    const now = new Date();
    if ((now - createdAt) > 10 * 60 * 1000) {
      return setStatus("Code expired");
    }

    // ✅ Code correctness check
    if (codeData.code !== inputCode) return setStatus("Incorrect code");

    // Mark the code as verified
    await supabase.from("email_verifications")
      .update({ verified: true })
      .eq("id", codeData.id);

    // ------------------ Create Supabase user (no confirmation email) ------------------
    const { data: signUpData, error: signUpError } = await supabase.auth.signUp({
      email: tempEmail,
      password: tempPassword
    });
    if (signUpError) return setStatus(signUpError.message);

    // ------------------ Sign in immediately ------------------
    const { error: signInError } = await supabase.auth.signInWithPassword({
      email: tempEmail,
      password: tempPassword
    });
    if (signInError) return setStatus(signInError.message);

    // ------------------ Clear temporary storage ------------------
    tempEmail = "";
    tempPassword = "";

    setStatus("Verified and account created! Redirecting...", "green");
    window.location.href = "survey.html";

  } catch (err) {
    console.error("Verification error:", err);
    setStatus("Something went wrong during verification.");
  }
});

document.getElementById("forgotPasswordLink").addEventListener("click", async (e) => {
  e.preventDefault();
  setStatus(""); // clear previous status

  const email = document.getElementById("signEmail").value.trim();
  if (!email) return setStatus("Please enter your email");

  try {
    // Step 1: Request Supabase to generate a secure reset link
    const { data, error } = await supabase.auth.resetPasswordForEmail(email, {
      redirectTo: 'https://vegan-buddy.vercel.app/reset-password.html' // your custom reset page
    });

    if (error) {
      console.error("Supabase resetPasswordForEmail error:", error);
      return setStatus("Failed to send reset link. Try again later.");
    }

    const resetLink = data?.action_link;
    if (!resetLink) return setStatus("Could not generate reset link. Try again later.");

    // Step 2: Send the reset link via EmailJS
    await emailjs.send("service_50i8a3q", "template_0qmhcvi", {
      user_email: email,
      reset_link: resetLink
    });

    setStatus("A password reset link has been sent to your email!", "green");

  } catch (err) {
    console.error("Forgot password error:", err);
    setStatus("Something went wrong. Try again later.");
  }
});


</script>



<style>
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #cceff0;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    text-align: center;
    padding: 2rem;
}
h1, h2 { color: #333; }
input { width: 80%; margin: 0.5rem 0; padding: 0.8rem; border-radius: 10px; border: 1px solid #ccc; }
button { padding: 0.8rem 2rem; border-radius: 8px; background-color: #4CAF50; color: white; border: none; cursor: pointer; margin: 0.5rem 0; }
button:hover { background-color: #45a049; }
</style>

</body>
</html>
