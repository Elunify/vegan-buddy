<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>MainPage</title>
  <link rel="stylesheet" href="homepagestyle.css" />
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>  
</head>
<body>
  <div id="loadingOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999;">
  <p style="text-align:center; margin-top:50vh;">Loading...</p>
  </div>

<div id="homepageContent" style="opacity:0;">
  <!-- All homepage content here -->

<div id="main-container">
    <!-- ğŸ  Home Content -->
  <div id="home" class="page">  <!-- ğŸ” Top Tabs -->

    <div class="top-bar">
      <div class="top-bar-row">

        <!-- Profile -->
        <div class="profile-wrapper">
          <img id="profilePhoto" src="" alt="Profile Photo" class="profile-photo" />
          <div id="petDisplay" class="pet-overlay"></div>
        </div>

        <!-- Level + Streak -->
        <div class="center-counters">
          <span class="counter">ğŸŒ <span id="currentLevel">0</span></span>
          <span class="counter" id="streak">
            <span class="fire">ğŸ”¥</span> 
            <span id="streak-counter">0</span>
          </span>
        </div>

        <!-- Side Menu -->
        <div id="menuButton" class="menu-button">â˜°</div>
        <div id="sideMenu" class="side-menu">
          <button class="menu-item" id="helpusgrowBtn">Help Us Grow</button>
          <button class="menu-item" id="aboutUsBtn">About Us</button>
        </div>
      </div>

      <!-- XP Progress -->
      <div class="level-bar">
        <div class="progress">
          <div id="levelProgress" class="progress-fill"></div>
        </div>
        <small id="xpToNext"> </small>
      </div>
    </div>
    <!-- End Top Tabs -->


      <div class="top-buttons-wrapper">
        <div class="top-buttons">
        <button id="checkinBtn" class="checkin-btn"><span class="btn-text">Daily Check-in</span></button>
        <button id="healthBtn" class="health-btn hidden"><span class="btn-text">Health Solutions</span></button>
      </div>

  <!-- Column of quick access buttons -->
      <div class="quick-access">
        <button id="lessonsBtn" class="quick-btn">ğŸ“š</button>
        <button id="recipesBtn" class="quick-btn">ğŸ½ï¸</button>
      </div>
    </div>

<div class = impact-box>
  <p><span class="you">You, </span>and our <span class="community">Community</span> <br>
  
<div class="impact-cards">
  
  <!-- Animals -->
  <div class="card">
    ğŸ¾
    <p> saved <br>
       <strong id="youAnimals">12</strong> 
       <strong id="communityAnimals">3560</strong> </p>
    <p>animals</p>
  </div>

  <!-- Forest -->
  <div class="card">
    ğŸŒ²
    <p> saved <br>
       <strong id="youForest">12</strong> 
       <strong id="communityForest">3560</strong> </p>
    <p> mÂ² of forests</p>
  </div>

  <!-- Water -->
  <div class="card">
    ğŸ’§
    <p> saved <br>
       <strong id="youWater">12</strong> 
       <strong id="communityWater">3560</strong> </p>
    <p>L of water</p>
  </div>

  <!-- COâ‚‚ -->
  <div class="card">
    ğŸŒ¬ï¸
    <p> reduced <br>
       <strong id="youCO2">12</strong> 
       <strong id="communityCO2">3560</strong> </p>
    <p>kg of COâ‚‚</p>
  </div>
 </div>
</div>

      <!-- Meal-Art Contest -->
      <div class="meal-art-winners">
        <h3>ğŸ½ï¸ Meal-Art Winners This Week:</h3>
        <div class="meal-art-categories">

          <!-- Amateur -->
          <div class="meal-art-card">
            <h4>ğŸ¥• Home Chef</h4>
            <p class="winner-name" id="amateurName">Jane Doe</p>
            <img id="amateurImage" src="meals/amateur.jpg" alt="Amateur winning dish" class="meal-art-image">
            <div id="amateurRecipe"><span class="recipe">Recipe available</span></div>
          </div>

          <!-- Professional -->
          <div class="meal-art-card">
            <h4>ğŸ´ Pro Kitchen</h4>
            <p class="winner-name" id="proName">Green Leaf Bistro</p>
            <img id="proImage" src="meals/professional.jpg" alt="Professional winning dish" class="meal-art-image">
            <div id="professionalRecipe"><span class="no-recipe">Recipe unavailable</span></div>
          </div>
        </div>
      </div>
  </div>  
<!-- End Home Page-->
 <!-- End Home Page-->
  <!-- End Home Page-->
   <!-- End Home Page-->
    <!-- End Home Page-->



    <!-- Top Bar -->
    <div id="settings" class="page hidden"> ...Profile Settings... </div>
    <div id="supportus" class="page hidden"> ...Support Us... </div>
    <div id="aboutus" class="page hidden"> ...About Us... </div>

    <!-- Learn subsections -->
    <div id="lessons" class="page hidden"> ...Lessons content... </div>
    <div id="recipes" class="page hidden"> ...Recipes content... </div>
    <div id="recommendations" class="page hidden"> ...Recommendations content... </div>
    <div id="sources" class="page hidden"> ...Sources content... </div>

    <!-- Explore subsections -->
    <div id="restaurants" class="page hidden"> ...Restaurants Map... </div>
    <div id="scan" class="page hidden"> ...Scan Products... </div>

    <!-- Community subsections -->
    <div id="local" class="page hidden"> ...Local Community... </div>
    <div id="events" class="page hidden"> ...Events... </div>
    <div id="forum" class="page hidden"> ...Forum... </div>
    <div id="friends" class="page hidden"> ...Friends... </div>
    <div id="mentorship" class="page hidden"> ...Mentorship... </div>
    <div id="success" class="page hidden"> ...Success Stories... </div>

    <!-- Playground subsections -->
    <div id="avatar" class="page hidden"> ...Your Avatar... </div>
    <div id="shop" class="page hidden"> ...Shop... </div>
    <div id="leaderboards" class="page hidden"> ...Leaderboards... </div>
    <div id="challenges" class="page hidden"> ...Challenges... </div>



    <!-- ğŸ”– Bottom Navigation -->
    <div class="bottom-nav">
      <button onclick="showSection('home')">ğŸ </button>
      <div class="dropdown">
        <button>ğŸ“– </button>
        <div class="dropdown-content">
          <button onclick="showSection('lessons')">Lessons</button>
          <button onclick="showSection('recipes')">Recipes</button>
          <button onclick="showSection('recommendations')">Recommendations</button>
          <button onclick="showSection('sources')">Sources</button>
        </div>
      </div>
      <div class="dropdown">
        <button>ğŸ” </button>
        <div class="dropdown-content">
          <button onclick="showSection('restaurants')">Restaurants</button>
          <button onclick="showSection('scan')">Scan Products</button>
        </div>
      </div>
      <div class="dropdown">
        <button>ğŸŒ </button>
        <div class="dropdown-content">
          <button onclick="showSection('local')">Local Community</button>
          <button onclick="showSection('events')">Events</button>
          <button onclick="showSection('forum')">Forum</button>
          <button onclick="showSection('friends')">Friends</button>
          <button onclick="showSection('mentorship')">Mentorship</button>
          <button onclick="showSection('success')">Success Stories</button>
        </div>
      </div>
      <div class="dropdown">
        <button>ğŸ§¸ </button>
        <div class="dropdown-content">
          <button onclick="showSection('avatar')">Your Avatar</button>
          <button onclick="showSection('shop')">Shop</button>
          <button onclick="showSection('leaderboards')">Leaderboards</button>
          <button onclick="showSection('challenges')">Challenges</button>
        </div>
      </div>
    </div>

</div> 
<!-- End main-container -->
 <!-- End main-container -->
  <!-- End main-container -->
   <!-- End main-container -->
    <!-- End main-container -->


<div class="avatar-row" style="display: none;">
    <!-- Eluna -->
<div class="profile-wrapper" onclick="toggleThought('eluna')">
  <img class="avatar" src="characters/eluna.png" alt="Eluna">
  <div class="thought-toggle" >ğŸ’­</div>
  <div id="elunaThought" class="thought-bubble">
    <span>Eluna</span> is thinking...
    <div id="elunaTip" class="lesson-box"></div>
  </div>
</div>

<!-- Elune -->
<div class="profile-wrapper" onclick="toggleThought('elune')">
  <img class="avatar" src="characters/elune.png" alt="Elune">
  <div class="thought-toggle">ğŸ’­</div>
  <div id="eluneThought" class="thought-bubble">
    <span>Elune</span> is thinking...
    <div id="eluneTip" class="lesson-box"></div>
  </div>
</div>

<!-- Pet -->
<div class="profile-wrapper" onclick="toggleThought('pet')">
  <div class="avatar" id="petAvatar"></div><!-- Will be replaced by image -->
  <div class="thought-toggle">ğŸ’­</div>
  <div id="petThought" class="thought-bubble">
    <span id="petName">Pet</span> is thinking...
    <div id="petTip" class="lesson-box"></div>
  </div>
</div>
</div>

</div> 
<!-- End homepageContent -->
 <!-- End homepageContent -->
  <!-- End homepageContent -->
   <!-- End homepageContent -->
    <!-- End homepageContent -->



<script type="module" src="scriptpools.js"></script>
<script type="module" src="scriptcalculationandinserts.js"></script>
<script type="module" src="scriptfunctions.js"></script>
<script type="module" src="scriptreads.js"></script>
<script type="module" src="scriptbuttons.js"></script>

  <script type="module">
  import { supabase } from "./supabaseClient.js";
  document.addEventListener("DOMContentLoaded", async () => {
  const loadingOverlay = document.getElementById("loadingOverlay");
  const homepageContent = document.getElementById("homepageContent"); // wrap your homepage content

  // Helper: Calculate level from XP
  function getLevelFromXP(totalXP) {
    let level = 1;
    let xpNeededForNext = 100;
    let xpLeft = totalXP;

    while (xpLeft >= xpNeededForNext && level < 100) {
      xpLeft -= xpNeededForNext;
      level++;
      xpNeededForNext = Math.floor(xpNeededForNext * 1.05);
    }

    return { level, xpTowardsNextLevel: xpLeft, xpNeededForNextLevel: xpNeededForNext };
  }

  // Wait for auth and profile
  const { data: { user }, error: authError } = await supabase.auth.getUser();
  if (!user || authError) {
    console.warn("Not logged in or auth error:", authError);
    if (loadingOverlay) loadingOverlay.style.display = "none";
    if (homepageContent) homepageContent.style.opacity = 1;
    return;
  }

  const { data: profile, error: profileError } = await supabase
    .from("profiles")
    .select("*")
    .eq("id", user.id)
    .single();

  if (!profile || profileError) {
    console.error("Profile not found:", profileError);
    if (loadingOverlay) loadingOverlay.style.display = "none";
    if (homepageContent) homepageContent.style.opacity = 1;
    return;
  }

  // Wait for all images on the page
  await Promise.all(Array.from(document.images).map(img => {
    if (img.complete) return Promise.resolve();
    return new Promise(resolve => img.onload = img.onerror = resolve);
  }));

  // Optional delay 
  await new Promise(resolve => setTimeout(resolve, 300)); //1000 = 1 second

  // Update XP progress
  const countersElements = {
    levelBar: document.getElementById('levelProgress'),
    currentLevelEl: document.getElementById("currentLevel"),
  };

  const { level, xpTowardsNextLevel, xpNeededForNextLevel } = getLevelFromXP(profile.total_xp || 0);

  if (countersElements.levelBar) {
    if (level >= 100) {
      countersElements.levelBar.style.display = "none";
    } else {
      countersElements.levelBar.style.display = "block";
      let progressPercent = (xpTowardsNextLevel / xpNeededForNextLevel) * 100;
      progressPercent = Math.min(progressPercent, 100);
      countersElements.levelBar.style.width = progressPercent + '%';
      // countersElements.levelBar.textContent = progressPercent.toFixed(0) + '%'; // optional
      if (countersElements.currentLevelEl) countersElements.currentLevelEl.textContent = level;
    }
  }

  // Show the page
  if (loadingOverlay) loadingOverlay.style.display = "none";
  if (homepageContent) homepageContent.style.opacity = 1;
});
</script>
</body>
</html>