<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login</title>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

</head>
<body>
  <!-- Login Section -->
<div id="loginSection">
  <h1>Welcome! Sign in or create a profile</h1>
  <input type="email" id="signEmail" placeholder="Enter your email" />
  <input type="password" id="signPassword" placeholder="Enter your password" />
  <button id="signInBtn">Sign In</button>

  <div id="forgotPassword" style="margin-bottom: 0.5rem;">
      <a href="#" id="forgotPasswordLink">Forgot your password?</a>
      <div id="forgotMsg" style="color: green; margin-top: 5px;"></div>
  </div>

  <button id="showProfileBtn">Create Profile</button>
</div>

<!-- New Profile Section -->
<div id="newProfileStep1" style="display:none;">
  <h2>Create a Profile</h2>
  <label class="smallLabel">Email:</label><br>
  <input type="text" id="profileEmail" placeholder="Your email" />
  <div id="passwordSection">
    <label class="smallLabel">Create a password</label>
    <input type="password" id="profilePassword1" placeholder="Enter password">
    <input type="password" id="profilePassword2" placeholder="Confirm password">
  </div>
  <div id="emailStatus" style="color: green; min-height: 20px;"></div>
  <button id="newProfileBtn">Create an account</button>
  <button id="backToLoginBtn" style="margin-top: 10px;">Do you have a profile already?</button>
</div>

<!-- Hidden Verification Code Section -->
<div id="verifyCodeSection" style="display:none;">
  <h3>Enter Verification Code</h3>
  <input type="text" id="verificationCode" placeholder="Enter code" />
  <button id="verifyCodeBtn">Verify</button>
</div>

<p id="statusMsg"></p>

<script type="module">
  import { supabase } from "./supabaseClient.mjs";
  
const statusMsg = document.getElementById("statusMsg");
emailjs.init("_BvHMRNPejeC7Wsha");

function setStatus(msg, color = "red") {
  statusMsg.style.color = color;
  statusMsg.textContent = msg || "";
}

// Show profile section
document.getElementById("showProfileBtn").addEventListener("click", () => {
  document.getElementById("loginSection").style.display = "none";
  document.getElementById("newProfileStep1").style.display = "block";
  setStatus("");
});

// Back to login
document.getElementById("backToLoginBtn").addEventListener("click", () => {
  document.getElementById("newProfileStep1").style.display = "none";
  document.getElementById("loginSection").style.display = "block";
  setStatus("");
});

// ------------------ Login ------------------
document.getElementById("signInBtn").addEventListener("click", async () => {
    const email = document.getElementById("signEmail").value;
    const password = document.getElementById("signPassword").value;

    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) return alert("Login failed: " + error.message);

    // send user_id to Expo app if inside WebView
if (window.ReactNativeWebView && data.user) {
  window.ReactNativeWebView.postMessage(JSON.stringify({
    type: 'userInfo',
    user_id: data.user.id
  }));
}

    window.location.href = "homepage.html";
      });

// ------------------ Generate 6-digit code ------------------
function generateCode(length = 6) {
  let code = '';
  for (let i = 0; i < length; i++) code += Math.floor(Math.random() * 10);
  return code;
}

// ------------------ Send verification code ------------------
async function sendVerificationCode(email) {
  const code = generateCode();
  const nowIso = new Date().toISOString();

  // upsert so there's only one row per email (requires unique index on email)
  const { error: dbError } = await supabase
    .from('email_verifications')
    .upsert([{ email, code, created_at: nowIso, verified: false }], { onConflict: 'email' });

  if (dbError) {
    console.error("DB save error:", dbError);
    return setStatus("Failed to save verification code. Try again later.");
  }

  try {
    await emailjs.send("service_50i8a3q", "template_0g6ty24", {
      user_email: email,
      verification_code: code
    });
    document.getElementById("verifyCodeSection").style.display = "block";
  } catch (err) {
    console.error("EmailJS send error:", err);
    // If email send fails, we might want to remove the saved code so users can retry
    await supabase.from('email_verifications').delete().eq('email', email);
    setStatus("Failed to send verification email. Try again later.");
  }
}

// ------------------ Temp storage ------------------
let tempEmail = "";
let tempPassword = "";
let codeSentEmails = {}; // { email: timestamp } to track rate limiting

// ------------------ Request verification (step 1) ------------------
document.getElementById("newProfileBtn").addEventListener("click", async () => {
  setStatus("");
  const email = document.getElementById("profileEmail").value.trim();
  const password = document.getElementById("profilePassword1").value.trim();
  const password2 = document.getElementById("profilePassword2").value.trim();

  if (!email || !password || !password2) return setStatus("Please fill in all fields");
  if (password !== password2) return setStatus("Passwords don't match");
  if (password.length < 6) return setStatus("Password must be at least 6 characters long");

  tempEmail = email;
  tempPassword = password;

  const { data: existingProfile } = await supabase
  .from('profiles')
  .select('id')
  .eq('email', tempEmail)
  .maybeSingle();

if (existingProfile) {
  return setStatus("A profile with this email already exists");
}

  // Rate limit: 1 code per 2 minutes
  const lastSent = codeSentEmails[email] || 0;
  if (Date.now() - lastSent < 2 * 60 * 1000) {
    return setStatus("Verification code already sent. Please wait a bit.", "orange");
  }

  codeSentEmails[email] = Date.now();

  document.getElementById("newProfileStep1").style.display = "none";
  document.getElementById("verifyCodeSection").style.display = "block";

  try {
    await sendVerificationCode(email);
    setStatus("Verification code sent! Check your email.", "green");
  } catch (err) {
    console.error("Failed to send verification code:", err);
    setStatus("Failed to send verification code. Try again later.", "red");
    codeSentEmails[email] = 0; // allow retry
  }
});

// ------------------ Verify code + create user (step 2) ------------------
document.getElementById('verifyCodeBtn').addEventListener('click', async () => {
  setStatus("");
  const inputCode = document.getElementById('verificationCode').value.trim();
  if (!inputCode) return setStatus("Please enter the verification code");

  try {
    // Get the latest unverified code for this email
    const { data: codeData, error: codeError } = await supabase
      .from("email_verifications")
      .select("*")
      .eq("email", tempEmail)
      .eq("verified", false)
      .order("created_at", { ascending: false })
      .limit(1)
      .single();

    if (codeError || !codeData) return setStatus("No code found for this email");

    // ✅ Expiration check using created_at (10 minutes)
    const createdAt = new Date(codeData.created_at);
    const now = new Date();
    if ((now - createdAt) > 10 * 60 * 1000) {
      return setStatus("Code expired");
    }

    // ✅ Code correctness check
    if (codeData.code !== inputCode) return setStatus("Incorrect code");

    // Mark the code as verified
    await supabase.from("email_verifications")
      .update({ verified: true })
      .eq("id", codeData.id);

    // ------------------ Create Supabase user (no confirmation email) ------------------
    const { data: signUpData, error: signUpError } = await supabase.auth.signUp({
      email: tempEmail,
      password: tempPassword
    });
    if (signUpError) return setStatus(signUpError.message);

    // ------------------ Sign in immediately ------------------
    const { error: signInError } = await supabase.auth.signInWithPassword({
      email: tempEmail,
      password: tempPassword
    });
    if (signInError) return setStatus(signInError.message);

    
// send user_id to Expo app if inside WebView
if (window.ReactNativeWebView && signUpData.user) {
  window.ReactNativeWebView.postMessage(JSON.stringify({
    type: 'userInfo',
    user_id: signUpData.user.id
  }));
}

    // ------------------ Clear temporary storage ------------------
    tempEmail = "";
    tempPassword = "";

    setStatus("Verified and account created! Redirecting...", "green");
    window.location.href = "survey.html";

  } catch (err) {
    console.error("Verification error:", err);
    setStatus("Something went wrong during verification.");
  }
});

// ------------------ forgot password ------------------
document.getElementById("forgotPasswordLink").addEventListener("click", async (e) => {
  e.preventDefault();
  setStatus("");

  const email = document.getElementById("signEmail").value.trim();
  if (!email) return setStatus("Please enter your email");

  try {
    // Check if profile exists
    const { data: existingProfile, error: profileError } = await supabase
      .from("profiles")
      .select("id")
      .eq("email", email)
      .maybeSingle();

    if (profileError) {
      console.error("Profile lookup error:", profileError);
      return setStatus("Something went wrong. Try again later.");
    }

    if (!existingProfile) {
      return setStatus("No account found with this email");
    }

    // Generate 6-digit code
    const code = generateCode();
    const nowIso = new Date().toISOString();

    // Save code in password_resets table
    const { error: dbError } = await supabase
      .from("password_resets")
      .upsert([{ email, code, created_at: nowIso, used: false }], { onConflict: 'email' });

    if (dbError) {
      console.error("DB save error:", dbError);
      return setStatus("Failed to create reset request. Try again later.");
    }

    // Send email via EmailJS
// Send code via EmailJS (just the code, no link)
await emailjs.send("service_50i8a3q", "template_0qmhcvi", {
  user_email: email,
  reset_code: code,
});

// Show success message
setStatus("Password reset code sent! Check your inbox (or spam).", "green");

// Redirect to reset-password.html and pass email in URL
setTimeout(() => {
  window.location.href = `reset-password.html?email=${encodeURIComponent(email)}`;
}, 2500);

  } catch (err) {
    console.error("Forgot password error:", err);
    setStatus("Something went wrong. Try again later.");
  }
});


</script>



<style>
/* ===== Reset & Body ===== */
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #f9f9f9;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  min-height: 100vh;
  padding: 2rem 1rem;
  color: #2d6a4f;
}

/* ===== Card Container ===== */
#loginSection, #newProfileStep1, #verifyCodeSection {
  background-color: #ffffff;
  border-radius: 20px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1);
  padding: 2rem;
  max-width: 400px;
  width: 90%;
  margin: 5%;
  margin-bottom: 2rem;
  transition: transform 0.3s ease, opacity 0.3s ease;
}

#loginSection h1,
#newProfileStep1 h2,
#verifyCodeSection h3 {
  text-align: center;
  margin-bottom: 1.5rem;
  color: #3bb341;
  font-size: 1.5rem;
}

/* ===== Inputs ===== */
input[type="email"], input[type="password"], input[type="text"] {
  width: 90%;
  padding: 0.9rem 1rem;
  margin-bottom: 1rem;
  border-radius: 12px;
  border: 1px solid #b7e4c7;
  font-size: 1rem;
  box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
  outline: none;
  transition: border-color 0.2s;
}

input[type="email"]:focus,
input[type="password"]:focus,
input[type="text"]:focus {
  border-color: #3bb341;
}

/* ===== Buttons ===== */
button {
  width: 100%;
  padding: 0.9rem 1rem;
  margin-bottom: 0.8rem;
  border-radius: 12px;
  border: none;
  font-size: 1.1rem;
  font-weight: bold;
  cursor: pointer;
  transition: background 0.2s, transform 0.1s;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

button:hover {
  transform: translateY(-2px);
}

#signInBtn {
  background-color: #3bb341;
  color: #fff;
}

#showProfileBtn, #newProfileBtn {
  background-color: #f0b429;
  color: #fff;
}

#backToLoginBtn {
  background-color: #d9f0e1;
  color: #3bb341;
}

#verifyCodeBtn {
  background-color: #3bb341;
  color: #fff;
}

/* ===== Links ===== */
#forgotPasswordLink {
  font-size: 0.9rem;
  color: #2d6a4f;
  text-decoration: underline;
}

#forgotPasswordLink:hover {
  color: #3bb341;
}

/* ===== Status messages ===== */
#statusMsg, #emailStatus, #forgotMsg {
  font-size: 0.9rem;
  min-height: 20px;
  margin-bottom: 0.8rem;
}

/* ===== Labels ===== */
.smallLabel {
  font-size: 0.9rem;
  color: #2d6a4f;
}

/* ===== Responsive ===== */
@media (max-width: 450px) {
  #loginSection, #newProfileStep1, #verifyCodeSection {
    padding: 1.5rem;
    border-radius: 16px;
  }

  input[type="email"], input[type="password"], input[type="text"], button {
    font-size: 1rem;
    padding: 0.8rem;
  }
}
</style>
</body>
</html>
